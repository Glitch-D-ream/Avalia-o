#!/usr/bin/env python3
# ============================================
# SCANNER DE VULNERABILIDADES EDUCACIONAL
# Detecta problemas de seguran√ßa comuns
# ============================================

import sys
import argparse
import subprocess
import nmap
import socket
from datetime import datetime

try:
    from scapy.all import ARP, Ether, srp
except ImportError:
    print("[!] Scapy n√£o instalado. Execute: pip install scapy")
    sys.exit(1)

class VulnerabilityScanner:
    def __init__(self, target_network):
        self.target_network = target_network
        self.vulnerabilities = []
        self.devices = {}
        
    def arp_scan(self):
        """Escanear rede com ARP"""
        print(f"\n[*] Escaneando rede: {self.target_network}")
        
        try:
            arp = ARP(pdst=self.target_network)
            ether = Ether(dst="ff:ff:ff:ff:ff:ff")
            packet = ether/arp
            
            result = srp(packet, timeout=2, verbose=False)[0]
            
            for sent, received in result:
                self.devices[received.psrc] = {
                    'ip': received.psrc,
                    'mac': received.hwsrc,
                    'vulnerabilities': []
                }
            
            print(f"[+] {len(self.devices)} dispositivos encontrados")
            return self.devices
        
        except Exception as e:
            print(f"[!] Erro no ARP scan: {e}")
            return {}
    
    def check_ports_and_services(self, ip)        """Verificar portas e servi√ßos abertos usando nmap"""
        vulnerabilities = []
        nm = nmap.PortScanner()
        
        # Escaneamento r√°pido de portas comuns (TCP SYN Scan) e execu√ß√£o de scripts NSE
        try:
            # O scan precisa ser executado com sudo, pois usa SYN Scan (-sS)
            # Argumentos: -sS (SYN Scan), -T4 (velocidade), --script (NSE para vulnerabilidades)
            nm.scan(ip, '21,22,23,80,443,8080', arguments='-sS -T4 --script http-enum,ssl-enum-ciphers,ftp-brute')
        except nmap.PortScannerError as e:
            print(f"[!] Erro ao escanear {ip}: {e}")
            return vulnerabilities
        
        if ip not in nm.all_hosts():
            return vulnerabilities

        # 1. An√°lise de Resultados de Scripts NSE (Novo)
        if 'hostscript' in nm[ip]:
            for script_result in nm[ip]['hostscript']:
                script_id = script_result['id']
                output = script_result['output']
                
                if output and output.strip() not in ['
', '']: # Ignorar scripts sem sa√≠da relevante
                    # L√≥gica de an√°lise de NSE para o Dashboard
                    severity = 'medium'
                    recommendation = 'Analisar a sa√≠da do script NSE para vulnerabilidades espec√≠ficas.'
                    
                    if 'VULNERABLE' in output.upper() or 'WEAK' in output.upper():
                        severity = 'critical'
                        recommendation = 'Vulnerabilidade confirmada. Aplicar patch ou desabilitar o servi√ßo.'
                    
                    vulnerabilities.append({
                        'name': f'NSE Script: {script_id.upper()}',
                        'severity': severity,
                        'description': f'Sa√≠da do script NSE:\
{output.strip()}',
                        'recommendation': recommendation
                    })

        # 2. Analisar resultados de Portas e Servi√ßos (Existente)
        for port in nm[ip]['tcp']:
            state = nm[ip]['tcp'][port]['state']
            service = nm[ip]['tcp'][port]['name']
            product = nm[ip]['tcp'][port]['product']
            version = nm[ip]['tcp'][port]['version']
            
            if state == 'open':
                description = f"Porta {port} aberta. Servi√ßo: {service}"
                recommendation = f"Verificar se o servi√ßo {service} √© necess√°rio e se est√° atualizado."
                severity = 'medium'
                
                if port == 80:
                    description += " (HTTP - Tr√°fego n√£o criptografado)"
                    recommendation = "Mudar para HTTPS (porta 443) imediatamente."
                    severity = 'high'
                
                if port == 23: # Telnet
                    description += " (Telnet - Inseguro)"
                    recommendation = "Desabilitar Telnet e usar SSH (porta 22)." 
                    severity = 'critical'
                
                if product and version:
                    description += f" ({product} {version})"
                    recommendation = f"Verificar vulnerabilidades conhecidas para {product} {version}."
                
                vulnerabilities.append({
                    'name': f'Porta {port} Aberta ({service.upper()})',
                    'severity': severity,
                    'description': description,
                    'recommendation': recommendation
                })
        
        return vulnerabilities
        
        # Analisar resultados do scan
        for port in nm[ip]['tcp']:
            state = nm[ip]['tcp'][port]['state']
            service = nm[ip]['tcp'][port]['name']
            product = nm[ip]['tcp'][port]['product']
            version = nm[ip]['tcp'][port]['version']
            
            if state == 'open':
                description = f"Porta {port} aberta. Servi√ßo: {service}"
                recommendation = f"Verificar se o servi√ßo {service} √© necess√°rio e se est√° atualizado."
                severity = 'medium'
                
                if port == 80:
                    description += " (HTTP - Tr√°fego n√£o criptografado)"
                    recommendation = "Mudar para HTTPS (porta 443) imediatamente."
                    severity = 'high'
                
                if port == 23: # Telnet
                    description += " (Telnet - Inseguro)"
                    recommendation = "Desabilitar Telnet e usar SSH (porta 22)." 
                    severity = 'critical'
                
                if product and version:
                    description += f" ({product} {version})"
                    recommendation = f"Verificar vulnerabilidades conhecidas para {product} {version}."
                
                vulnerabilities.append({
                    'name': f'Porta {port} Aberta ({service.upper()})',
                    'severity': severity,
                    'description': description,
                    'recommendation': recommendation
                })
        
        return vulnerabilities
    
    def check_router_vulnerabilities(self, ip):"""Verificar vulnerabilidades comuns em roteadores"""
        vulnerabilities = []
        
        # Verificar 192.168.1.1 (roteador t√≠pico)
        if ip == \"192.168.1.1\" or ip == \"192.168.0.1\":
            vulnerabilities.extend([
                {
                    'name': 'Senha Padr√£o do Roteador',
                    'severity': 'critical',
                    'description': 'Roteador pode estar usando credenciais padr√£o (admin/admin)',
                    'recommendation': 'Alterar senha padr√£o imediatamente'
                },
                {
                    'name': 'Firmware Desatualizado',
                    'severity': 'high',
                    'description': 'Firmware pode conter vulnerabilidades conhecidas',
                    'recommendation': 'Atualizar firmware para vers√£o mais recente'
                },
                {
                    'name': 'WiFi WEP Ativado',
                    'severity': 'critical',
                    'description': 'Criptografia WEP √© fraca e obsoleta',
                    'recommendation': 'Usar WPA3 ou WPA2 em vez de WEP'
                },
                {
                    'name': 'UPnP Habilitado',
                    'severity': 'high',
                    'description': 'UPnP pode permitir acesso n√£o autorizado',
                    'recommendation': 'Desabilitar UPnP se n√£o for necess√°rio'
                }
            ])
        
        return vulnerabilities
    
    def check_device_vulnerabilities(self, ip):
        \"\"\"Verificar vulnerabilidades em dispositivos\"\"\"
        vulnerabilities = []
        
        # Verificar se √© celular ou dispositivo
        if ip.endswith(\".50\") or ip.endswith(\".200\"):
            vulnerabilities.extend([
                {
                    'name': 'Conex√£o HTTP Insegura',
                    'severity': 'high',
                    'description': 'Dispositivo pode estar usando HTTP em vez de HTTPS',
                    'recommendation': 'Usar HTTPS para todas as conex√µes'
                },
                {
                    'name': 'Sem Prote√ß√£o de Tela',
                    'severity': 'medium',
                    'description': 'Dispositivo pode n√£o ter prote√ß√£o de tela ativada',
                    'recommendation': 'Ativar prote√ß√£o de tela com senha'
                }
            ])
        
        return vulnerabilities
    
    def scan_all(self):
        \"\"\"Escanear todos os dispositivos\"\"\"
        print(\"\\n\" + \"=\"*80)
        print(\"üîç SCANNER DE VULNERABILIDADES - LABORAT√ìRIO DEMON√çACO\")
        print(\"=\"*80 + \"\\n\")
        
        # Fazer ARP scan
        self.arp_scan()
        
        if not self.devices:
            print(\"[!] Nenhum dispositivo encontrado\")
            return
        
        # Verificar cada dispositivo
        for ip, info in self.devices.items():
            print(f\"\\n[*] Analisando: {ip}\")
            
            # Verificar vulnerabilidades
            vulns = []
            # 1. Escaneamento de Portas e Servi√ßos (Nmap)
            vulns.extend(self.check_ports_and_services(ip))
            # 2. Verifica√ß√µes Heur√≠sticas (Manter para o cen√°rio de laborat√≥rio)
            vulns.extend(self.check_router_vulnerabilities(ip))
            vulns.extend(self.check_device_vulnerabilities(ip))
            
            if vulns:
                info['vulnerabilities'] = vulns
                self.vulnerabilities.extend(vulns)
                print(f\"[!] {len(vulns)} vulnerabilidades encontradas\")
            else:
                print(\"[+] Nenhuma vulnerabilidade detectada\")
        
        # Exibir relat√≥rio
        self.display_report()
    
    def display_report(self):
        \"\"\"Exibir relat√≥rio de vulnerabilidades\"\"\"
        print(\"\\n\" + \"=\"*80)
        print(\"üìã RELAT√ìRIO DE VULNERABILIDADES\")
        print(\"=\"*80 + \"\\n\")
        
        # Contar por severidade
        critical = len([v for v in self.vulnerabilities if v['severity'] == 'critical'])
        high = len([v for v in self.vulnerabilities if v['severity'] == 'high'])
        medium = len([v for v in self.vulnerabilities if v['severity'] == 'medium'])
        
        print(f\"Total de vulnerabilidades: {len(self.vulnerabilities)}\")
        print(f\"  üî¥ Cr√≠ticas: {critical}\")
        print(f\"  üü† Altas: {high}\")
        print(f\"  üü° M√©dias: {medium}\")
        
        # Listar vulnerabilidades por dispositivo
        for ip, info in self.devices.items():
            if info['vulnerabilities']:
                print(f\"\\nüìç Dispositivo: {ip} ({info['mac']})\")
                print(\"-\" * 80)
                
                for vuln in info['vulnerabilities']:
                    severity_icon = {
                        'critical': 'üî¥',
                        'high': 'üü†',
                        'medium': 'üü°'
                    }.get(vuln['severity'], '‚ö™')
                    
                    print(f\"\\n{severity_icon} {vuln['name']} [{vuln['severity'].upper()}]\")
                    print(f\"   Descri√ß√£o: {vuln['description']}\")
                    print(f\"   Recomenda√ß√£o: {vuln['recommendation']}\")
        
        # Recomenda√ß√µes gerais
        print(\"\\n\" + \"=\"*80)
        print(\"üí° RECOMENDA√á√ïES GERAIS\")
        print(\"=\"*80 + \"\\n\")
        
        recommendations = [
            \"1. Altere todas as senhas padr√£o\",
            \"2. Atualize firmware de todos os dispositivos\",
            \"3. Use WPA3 ou WPA2 em vez de WEP\",
            \"4. Desabilite servi√ßos desnecess√°rios\",
            \"5. Use HTTPS em vez de HTTP\",
            \"6. Implemente firewall robusto\",
            \"7. Fa√ßa backup regular de dados\",
            \"8. Mantenha software atualizado\"
        ]
        
        for rec in recommendations:
            print(f\"  {rec}\")
        
        print(\"\\n\" + \"=\"*80 + \"\
\")

def main():
    parser = argparse.ArgumentParser(
        description=\"Scanner de vulnerabilidades educacional\"
    )
    parser.add_argument(
        \"--target\", \"-t\",
        default=\"192.168.1.0/24\",
        help=\"Rede alvo (ex: 192.168.1.0/24)\"
    )
    
    args = parser.parse_args()
    
    scanner = VulnerabilityScanner(args.target)
    scanner.scan_all()

if __name__ == \"__main__\":
    main()

