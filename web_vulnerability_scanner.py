#!/usr/bin/env python3
"""SCANNER DE VULNERABILIDADES WEB (DIRB)
Demonstra칞칚o educacional de enumera칞칚o de diret칩rios (coleta de dados)
usando a ferramenta real 'dirb'.
"""
import subprocess
import json
from typing import Dict, List

class WebVulnerabilityScanner:
    """Executa o dirb para encontrar diret칩rios e arquivos ocultos."""
    
    def __init__(self):
        pass
        
    def scan_directories(self, url: str) -> Dict:
        """Executa o dirb via subprocess."""
        print(f"[*] Iniciando enumera칞칚o de diret칩rios (dirb) em: {url}")
        
        results = {
            "url": url,
            "status": "FAILED",
            "hidden_paths": [],
            "error_message": ""
        }
        
        try:
            # Comando dirb: -z 10 (delay de 10ms entre requisi칞칫es para ser mais discreto)
            command = ["dirb", url, "-z", "10"]
            
            # Executar o comando e capturar a sa칤da
            process = subprocess.run(
                command,
                capture_output=True,
                text=True,
                timeout=60 # Timeout de 60 segundos
            )
            
            output = process.stdout
            
            # Analisar a sa칤da do dirb
            hidden_paths = []
            for line in output.splitlines():
                if "==> DIRECTORY" in line or "==> FILE" in line:
                    # Exemplo de linha: "==> DIRECTORY: http://alvo.com/admin/ (CODE:200|SIZE:123)"
                    try:
                        path = line.split(":")[2].split("(")[0].strip()
                        code = line.split("CODE:")[1].split("|")[0].strip()
                        hidden_paths.append({"path": path, "status_code": code})
                    except IndexError:
                        continue
            
            results["status"] = "SUCCESS"
            results["hidden_paths"] = hidden_paths
            print(f"[+] Enumera칞칚o conclu칤da. Caminhos ocultos encontrados: {len(hidden_paths)}")
            
        except FileNotFoundError:
            results["error_message"] = "Ferramenta 'dirb' n칚o encontrada. Certifique-se de que est치 instalada."
        except subprocess.TimeoutExpired:
            results["error_message"] = "O scan excedeu o tempo limite de 60 segundos."
        except Exception as e:
            results["error_message"] = str(e)
            
        return results

def main():
    scanner = WebVulnerabilityScanner()
    
    # Exemplo de uso (pode ser o site robusto do concurso ou um alvo de teste)
    target_url = "http://testphp.vulnweb.com/" 
    
    results = scanner.scan_directories(target_url)
    
    print("
" + "="*80)
    print("游늶 RELAT칍RIO DE ENUMERA칂츾O DE DIRET칍RIOS (DIRB)")
    print("="*80 + "
")
    print(json.dumps(results, indent=2, default=str))

if __name__ == "__main__":
    main()
